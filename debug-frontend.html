<!DOCTYPE html>
<html>
<head>
    <title>Debug Frontend Auth Cache</title>
</head>
<body>
    <h1>Debug Frontend Auth Cache</h1>
    
    <button onclick="testAuthWithCookies()">Test Auth with Cookies</button>
    <button onclick="testAuthWithHeaders()">Test Auth with Cache Headers</button>
    <button onclick="setCookiesManually()">Set Cookies Manually</button>
    <button onclick="clearAllCache()">Clear All Cache</button>
    
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            output.innerHTML += '<p>' + message + '</p>';
        }
        
        async function testAuthWithCookies() {
            log('Testing auth with cookies...');
            try {
                const response = await fetch('/api/auth/user', {
                    credentials: 'include'
                });
                
                log('Status: ' + response.status);
                if (response.ok) {
                    const data = await response.json();
                    log('User: ' + data.email);
                } else {
                    log('Error: ' + await response.text());
                }
            } catch (error) {
                log('Exception: ' + error.message);
            }
        }
        
        async function testAuthWithHeaders() {
            log('Testing auth with cache bypass headers...');
            try {
                const timestamp = Date.now();
                const response = await fetch(`/api/auth/user?_t=${timestamp}`, {
                    credentials: 'include',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                log('Status with cache bypass: ' + response.status);
                if (response.ok) {
                    const data = await response.json();
                    log('User with cache bypass: ' + data.email);
                } else {
                    log('Error with cache bypass: ' + await response.text());
                }
            } catch (error) {
                log('Exception with cache bypass: ' + error.message);
            }
        }
        
        function setCookiesManually() {
            log('Setting cookies manually...');
            // Set the cookies from the curl response
            document.cookie = 'token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsImlhdCI6MTc1NDQxOTUyMywiZXhwIjoxNzU0NDIwNDIzfQ.a8sjXzz9s-YeTWMJUm_CEjioLiSYiVHTnNfUfzcNcWE; path=/; max-age=900';
            document.cookie = 'refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsImlhdCI6MTc1NDQxOTUyMywiZXhwIjoxNzU1MDI0MzIzfQ.aCtm_fzD4OdXOCUweGpA8pLJkZMbwptLshkTRFzgR1Q; path=/; max-age=604800';
            log('Cookies set manually');
        }
        
        function clearAllCache() {
            log('Clearing all cache...');
            // Clear localStorage and sessionStorage
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear cookies
            document.cookie.split(";").forEach(function(c) {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            
            log('All cache cleared');
        }
        
        // Auto-test on load
        log('=== Auto Test on Load ===');
        setTimeout(() => {
            testAuthWithCookies();
        }, 1000);
    </script>
</body>
</html>